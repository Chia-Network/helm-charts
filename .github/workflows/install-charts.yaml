name: Test Install Charts

on: pull_request

jobs:
  install-charts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Install generic chart (deployment mode)
        uses: Chia-Network/actions/helm/deploy@main
        with:
          namespace: "generic"
          app_name: "generic-test"
          helm_chart: "./charts/generic"
          helm_values: "./charts/generic/values.yaml"

      - name: Verify generic chart created Deployment
        run: |
          kubectl get deployment generic-test -n generic
          if [ $? -eq 0 ]; then
            echo "✓ Deployment 'generic-test' exists in namespace 'generic'"
          else
            echo "✗ Deployment 'generic-test' not found"
            exit 1
          fi
          # Verify StatefulSet does NOT exist
          if kubectl get statefulset generic-test -n generic 2>/dev/null; then
            echo "✗ Unexpected StatefulSet found (should be Deployment)"
            exit 1
          else
            echo "✓ No StatefulSet found (correct)"
          fi

      - name: Test generic chart (stateful mode)
        uses: Chia-Network/actions/helm/deploy@main
        with:
          namespace: "generic-stateful-mode"
          app_name: "generic-stateful-mode-test"
          helm_chart: "./charts/generic"
          helm_values: "./charts/generic/test-values-stateful.yaml"

      - name: Verify generic chart (stateful mode) created StatefulSet
        run: |
          kubectl get statefulset generic-stateful-mode-test -n generic-stateful-mode
          if [ $? -eq 0 ]; then
            echo "✓ StatefulSet 'generic-stateful-mode-test' exists in namespace 'generic-stateful-mode'"
          else
            echo "✗ StatefulSet 'generic-stateful-mode-test' not found"
            exit 1
          fi
          # Verify Deployment does NOT exist
          if kubectl get deployment generic-stateful-mode-test -n generic-stateful-mode 2>/dev/null; then
            echo "✗ Unexpected Deployment found (should be StatefulSet)"
            exit 1
          else
            echo "✓ No Deployment found (correct)"
          fi

      - name: Test volume restrictions - Deployment with RWO and replicas > 1 (should fail)
        run: |
          set +e
          helm template test ./charts/generic -f ./charts/generic/test-values-deployment-rwo-fail.yaml 2>&1 | tee /tmp/helm-output.txt
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✗ Expected validation failure for RWO volume with replicas > 1, but helm template succeeded"
            exit 1
          fi
          if grep -q "cannot be used with deployments when replicaCount > 1" /tmp/helm-output.txt; then
            echo "✓ Validation correctly failed for RWO volume with replicas > 1"
          else
            echo "✗ Validation failed but with unexpected error message"
            cat /tmp/helm-output.txt
            exit 1
          fi

      - name: Test volume restrictions - Deployment with RWX and replicas > 1 (should succeed)
        run: |
          helm template test ./charts/generic -f ./charts/generic/test-values-deployment-rwx-success.yaml > /dev/null
          if [ $? -eq 0 ]; then
            echo "✓ Validation passed for RWX volume with replicas > 1"
          else
            echo "✗ Unexpected failure for RWX volume with replicas > 1"
            exit 1
          fi

      - name: Test volume restrictions - StatefulSet with RWO and replicas > 1 (should succeed)
        run: |
          helm template test ./charts/generic -f ./charts/generic/test-values-stateful.yaml > /dev/null
          if [ $? -eq 0 ]; then
            echo "✓ Validation passed for StatefulSet with RWO volume and replicas > 1"
          else
            echo "✗ Unexpected failure for StatefulSet with RWO volume and replicas > 1"
            exit 1
          fi

      - name: Install generic-stateful chart
        uses: Chia-Network/actions/helm/deploy@main
        with:
          namespace: "generic-stateful"
          app_name: "generic-stateful-test"
          helm_chart: "./charts/generic-stateful"
          helm_values: "./charts/generic-stateful/values.yaml"

      - name: Install chia-blockchain chart
        uses: Chia-Network/actions/helm/deploy@main
        with:
          namespace: "chia-blockchain"
          app_name: "chia-blockchain"
          helm_chart: "./charts/chia-blockchain"
          helm_values: "./charts/chia-blockchain/values.yaml"
